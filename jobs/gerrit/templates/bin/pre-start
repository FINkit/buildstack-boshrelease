#!/bin/bash

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

source /var/vcap/jobs/gerrit/helpers/ctl_setup.sh 'gerrit'

if [[ ! -d ${GERRIT_STORE} ]]; then
    mkdir -p ${GERRIT_STORE}
fi

if [ ! -f ${GERRIT_STORE}/etc/gerrit.config ]
then
    mkdir -p ${GERRIT_STORE}/etc/
    cp /var/vcap/jobs/gerrit/config/gerrit.config ${GERRIT_STORE}/etc/gerrit.config
    cp /var/vcap/jobs/gerrit/config/secure.config ${GERRIT_STORE}/etc/secure.config
fi

echo "Running initialisation script"
${JAVA} ${MEMORY_SETTINGS} ${JAVA_OPTS} -jar ${GERRIT} ${GERRIT_INIT_ARGS}

${JAVA} ${MEMORY_SETTINGS} ${JAVA_OPTS} -jar ${GERRIT} reindex --site-path ${GERRIT_STORE} 

chown vcap:vcap -R ${GERRIT_STORE}

